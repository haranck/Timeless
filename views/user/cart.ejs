<%- include("../../views/partials/user/header") %>

<style>
    .cart-img{
        max-width: 39%;    
    }

    .custom-quantity-input {
        display: flex;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
        width: fit-content;
    }

    .quantity-btn {
        background: #f8f9fa;
        border: none;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.2s;
    }

    .quantity-btn:hover {
        background: #e9ecef;
    }

    .quantity-value {
        width: 40px;
        text-align: center;
        border: none;
        border-left: 1px solid #ddd;
        border-right: 1px solid #ddd;
        padding: 8px 0;
        font-size: 14px;
    }

    .quantity-value::-webkit-inner-spin-button,
    .quantity-value::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>
    <!-- Breadcrumb Section Begin -->
    <section class="breadcrumb-option" >
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__text">
                        <h4>Shopping Cart</h4>
                        <div class="breadcrumb__links">
                            <a href="/">Home</a>
                            <a href="/shop">Shop</a>
                            <span>Shopping Cart</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Breadcrumb Section End -->

    <!-- Shopping Cart Section Begin -->
    <section class="shopping-cart spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    <div class="shopping__cart__table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if(cart.items.length > 0) { %>
                                    <% cart.items.forEach(item => { %>
                                        <tr>
                                            <td class="product__cart__item">
                                                <div class="product__cart__item__pic">
                                                    <img class="cart-img" src="/uploads/product-images/<%= item.productId.productImages[0] %> " alt="">
                                                </div>
                                                <div class="product__cart__item__text">
                                                    <h6><%= item.productId.productName %></h6>
                                                    <h5>₹<%= item.productId.finalPrice %></h5>
                                                </div>
                                            </td>
                                            <td class="quantity__item">
                                                <div class="custom-quantity-input">
                                                    <button class="quantity-btn" onclick="updateItemQuantity('<%= item.productId._id %>', 'decrease')">-</button>
                                                    <input type="number" class="quantity-value" value="<%= item.quantity %>" min="1" 
                                                        onchange="updateItemQuantity('<%= item.productId._id %>', 'set', this.value)"
                                                        readonly>
                                                    <button class="quantity-btn" onclick="updateItemQuantity('<%= item.productId._id %>', 'increase')">+</button>
                                                </div>
                                            </td>
                                            <td class="cart__price">₹<%= item.totalPrice%></td>
                                            <td class="cart__close">
                                                <a href="javascript:void(0);" onclick="confirmRemove('<%= item.productId._id %>')">
                                                    <i class="fa fa-close"></i>
                                                </a>
                                            </td>
                                            
                                        </tr>
                                    <% }); %>
                                <% } else { %>      
                                    <tr>
                                        <td colspan="4" class="text-center">No products in the cart</td>
                                    </tr>
                                <% } %>
                            </tbody>
                            
                        </table>
                    </div>
                    <div class="row">
                        <div class="col-lg-6 col-md-6 col-sm-6">
                            <div class="continue__btn">
                                <a href="/shop">Continue Shopping</a>
                            </div>
                        </div>
                        <!-- <div class="col-lg-6 col-md-6 col-sm-6">
                            <div class="continue__btn update__btn">
                                <a href="#"><i class="fa fa-spinner"></i> Update cart</a>
                            </div>
                        </div> -->
                    </div>
                </div>
                <div class="col-lg-4">
                    <!-- <div class="cart__discount">
                        <h6>Discount codes</h6>
                        <form action="#">
                            <input type="text" placeholder="Coupon code">
                            <button type="submit">Apply</button>
                        </form>
                    </div> -->
                    <div class="cart__total">
                        <h6>Cart total</h6>
                        <ul>
                            <li>Subtotal <span>₹<%=cart.totalPrice%></span></li>
                            <br>
                            <li>Total <span>₹<%=cart.totalPrice %></span></li>
                        </ul>
                        <% if (cart.totalPrice !== 0) { %> 
                        <a href="/checkout" class="primary-btn">Proceed to checkout</a>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        function confirmRemove(productId) {
            // Find the cart row before removal
            const cartRow = document.querySelector(`a[onclick="confirmRemove('${productId}')"]`).closest('tr');
            
            Swal.fire({
                title: 'Are you sure?',
                text: "This item will be removed from your cart.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, remove it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/cart/remove/${productId}`, { 
                        method: "DELETE",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            
                            cartRow.remove();
                            
                        
                            calculateTotalPrice();
                            
                            // Check if cart is empty
                            const remainingItems = document.querySelectorAll('tr').length;
                            if (remainingItems <= 1) {
                                location.reload(); // Reload to show empty cart message
                            }

                            Swal.fire('Removed!', 'Your item has been removed.', 'success');
                        } else {
                            Swal.fire('Error!', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        Swal.fire('Error!', 'Something went wrong.', 'error');
                    });
                }
            });
        }

        function calculateTotalPrice() {
            const cartRows = document.querySelectorAll('tr');
            let subtotal = 0;

            cartRows.forEach(row => {
                const priceElement = row.querySelector('.cart__price');
                if (priceElement) {
                    const price = parseFloat(priceElement.textContent.replace('₹', ''));
                    if (!isNaN(price)) {
                        subtotal += price;
                    }
                }
            });

            // Add IDs to the price elements in the HTML for easier selection
            document.querySelectorAll('ul li').forEach(li => {
                const text = li.childNodes[0].textContent.trim();
                if (text === 'Subtotal') {
                    li.querySelector('span').textContent = `₹${subtotal.toFixed(2)}`;
                }
                if (text === 'Total') {
                    li.querySelector('span').textContent = `₹${subtotal.toFixed(2)}`;
                }
            });

            return subtotal;
        }

        // Call the function when page loads
        document.addEventListener('DOMContentLoaded', calculateTotalPrice);

        async function updateItemQuantity(productId, action, value = null) {
            let quantityInput = event.target.parentElement.querySelector('.quantity-value');
            let currentQuantity = parseInt(quantityInput.value);
            let newQuantity = currentQuantity;
            newQuantity = action === 'increase' ? currentQuantity + 1 : currentQuantity - 1 ;
            if(newQuantity > 5){
                Swal.fire({
                    title:'Error!', 
                    text:'You can only order up to 5 items.',
                    icon:'error',
                    showConfirmButton:false,
                    timer:1500
                }); 
                return;
            }
            if(newQuantity < 1){
                Swal.fire({
                    title:'Error!', 
                    text:'You can not order less than 1 item.',
                    icon:'error',
                    showConfirmButton:false,
                    timer:1500
                }); 
                return;
            }
            const response = await fetch('/addToCart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    productId: productId,
                    quantity: action === 'increase' ? 1 : -1
                })
            } )
            const data = await response.json();
            if(!response.ok){
                Swal.fire('Error!', data.message, 'error');
                return;
            }
 
            // await Swal.fire('Success!', '', 'success');
            await Swal.fire({
                title: 'Success!',
                icon: 'success',
                showConfirmButton: false,
                timer: 1000
            })

            if (newQuantity !== currentQuantity) {  // If quantity changed
                quantityInput.value = newQuantity;
                
                // Update the price for this item
                const pricePerUnit = parseFloat(quantityInput.closest('tr').querySelector('.product__cart__item__text h5').textContent.replace('₹', ''));
                const totalPriceElement = quantityInput.closest('tr').querySelector('.cart__price');
                totalPriceElement.textContent = `₹${(pricePerUnit * newQuantity).toFixed(2)}`;

                // Recalculate total cart price
                calculateTotalPrice()            
            }
        }
    </script>

    <%- include("../../views/partials/user/footer") %>