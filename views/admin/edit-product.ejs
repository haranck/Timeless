<%- include("../../views/partials/admin/header") %>

<head>
    <style>
        .thumbnails-container {
            display: flex;
            overflow-x: auto;
            margin-bottom: 15px;
        }

        .thumbnail {
            margin-right: 10px;
        }

        .input-upload {
            position: relative;
        }

        .error-message {
            color: red;
            display: none;
        }

        .card-body {
            padding: 20px;
        }

        /* Form Styling */
        .form-label {
            font-weight: bold;
        }

        .form-control {
            margin-bottom: 15px;
        }

        /* Sidebar layout */
        .content-main {
            margin-left: 20px;
            margin-right: 20px;
            margin-top: 50px;
        }

        /* Image preview */
        #imgView1 {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
        }

        .card-header {
            background-color: #f5f5f5;
            padding: 10px;
        }

        .btn-update {
            margin-top: 20px;
        }

        .col-lg-4 {
            width: 100%;
        }

        .col-lg-8 {
            width: 100%;
        }

        .save-button {
            display: none;
            margin-top: 15px;
        }
    </style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.css">
</head>

<section class="content-main">
    <div class="row">
        <div class="col-9">
            <div class="content-header">
                <h2 class="content-title">Edit Product</h2>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card mb-4"  style="margin-left: 250px;">
                <div class="card-body">
                    <form method="post" action="/admin/editProduct/<%= product._id %>" enctype="multipart/form-data" onsubmit="return validateForm()" class="edit-product-form">
                        <!-- Product Name -->
                        <div class="mb-4">
                            <label for="product_name" class="form-label">Product Name</label>
                            <input type="text" name="productName" value="<%= product.productName %>" class="form-control border" id="product_name">
                            <div id="productName-error" class="error-message"></div>
                        </div>

                        <!-- Product Description -->
                        <div class="mb-4">
                            <label for="description" class="form-label">Full Description</label>
                            <textarea name="descriptionData" class="form-control border" rows="4"><%= product.description %></textarea>
                            <div id="description-error" class="error-message"></div>
                        </div>

                        <!-- Regular Price -->
                        <div class="col-lg-4 mb-4">
                            <label for="regularPrice" class="form-label">Regular Price</label>
                            <input placeholder="$" name="regularPrice" type="text" value="<%= product.regularPrice %>" class="form-control border" id="regularPrice">
                            <div id="regularPrice-error" class="error-message"></div>
                        </div>

                        <!-- Sale Price -->
                        <div class="col-lg-4 mb-4">
                            <label for="salePrice" class="form-label">Sale Price</label>
                            <input name="salePrice" type="text" value="<%= product.salePrice %>" class="form-control border" id="salePrice">
                            <div id="salePrice-error" class="error-message"></div>
                        </div>

                        <!-- Quantity -->
                        <div class="col-lg-4 mb-4">
                            <label for="quantity" class="form-label">Quantity</label>
                            <input name="quantity" type="text" value="<%= product.quantity %>" class="form-control border" id="quantity">
                            <div id="quantity-error" class="error-message"></div>
                        </div>

                        <!-- Category -->
                        <div class="mb-4">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select border" name="category">
                                <% for (let i = 0; i < cat.length; i++) { %>
                                    <option value="<%= cat[i]._id %>" <%= product.category._id.toString() === cat[i]._id.toString() ? 'selected' : '' %>> 
                                        <%= cat[i].name %>
                                    </option>
                                <% } %>
                            </select>
                            <div id="category-error" class="error-message"></div>
                        </div>

                        <!-- Existing Images -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h4>Existing Images</h4>
                            </div>
                            <div class="card-body">
                                <div class="thumbnails-container">
                                    <% if (product.productImages && product.productImages.length > 0) { %>
                                        <% product.productImages.forEach((image, index) => { %>
                                            <div class="thumbnail">
                                                <img src="/uploads/products/<%= image %>" alt="Product Image" style="width: 80px; height: 80px;">
                                                <i onclick="deleteImage('<%= image %>', '<%= product._id %>')" class="fa fa-trash" style="cursor: pointer;"></i>
                                            </div>
                                        <% }) %>
                                    <% } else { %>
                                        <p>No images available</p>
                                    <% } %>
                                </div>
                            </div>
                        </div>

                        <!-- Upload New Image -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h4>Choose New Image</h4>
                            </div>
                            <div class="card-body">
                                <div class="input-upload">
                                    <img id="imgView1" src="" alt="" style="width: 100%; max-width: 200px;">
                                    <input type="file" class="form-control" name="images" id="input1" accept="image/png, image/jpeg, image/jpg" onchange="cropImage()">
                                    <div id="images-error" class="error-message"></div>
                                </div>
                                <!-- Save button appears only after selecting an image -->
                                <button type="button" id="saveImageBtn" class="btn btn-primary save-button" onclick="saveImage()">Save Image</button>
                            </div>
                        </div>

                        <!-- Update Button -->
                        <button type="submit" class="btn btn-md btn-primary btn-update">Update</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="cropperModal" style="display: none">
       <div>
          <img id="cropImage" />
         </div>
         <button id="crop-button">Crop</button>
         <button id="cancel-button">Cancel</button>
      </div>
   </section>  

<style>
   #cropperModal{
      position: fixed;
      top: 50%;
      right: 50%;
   }
</style>

<script src="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.js"></script>

<%- include("../../views/partials/admin/footer") %>

<script>
   function cropImage(e){
      console.log('lasdfl')
      console.log(e.target.files[0])
   }
    // Image Preview
    function viewImage1(event) {
        const imgView = document.getElementById('imgView1');
        const saveButton = document.getElementById('saveImageBtn');

        imgView.src = URL.createObjectURL(event.target.files[0]);

        // Show the save button when an image is selected
        saveButton.style.display = 'inline-block';
    }

    // Delete Image Function
    function deleteImage(image, productId) {
        if (confirm('Are you sure you want to delete this image?')) {
            // Add your delete image logic here, such as making an API call to remove the image


            console.log('Image Deleted: ', image);
        }
    }

    // Save Image Function
    function saveImage() {
        const imageInput = document.getElementById('input1');
        const existingImagesContainer = document.querySelector('.thumbnails-container');
        const newImage = imageInput.files[0];

        if (newImage) {
            const newImageElement = document.createElement('div');
            newImageElement.classList.add('thumbnail');
            newImageElement.innerHTML = `<img src="${URL.createObjectURL(newImage)}" alt="Product Image" style="width: 80px; height: 80px;">
                                         <i onclick="deleteImage('${newImage.name}', 'productId')" class="fa fa-trash" style="cursor: pointer;"></i>`;
            existingImagesContainer.appendChild(newImageElement);
        }

        // Hide the Save button after saving
        document.getElementById('saveImageBtn').style.display = 'none';
        alert('Image added successfully!');
    }

    // Form Validation
    function validateForm() {
        clearErrorMessages();
        const name = document.getElementsByName('productName')[0].value;
        const description = document.getElementsByName('descriptionData')[0].value;
        const price = document.getElementsByName('regularPrice')[0].value;
        const saleprice = document.getElementsByName('salePrice')[0].value;
        const quantity = document.getElementsByName('quantity')[0].value;
        const category = document.getElementsByName('category')[0].value;
        const images = document.getElementById('input1');

        let isValid = true;

        if (name.trim() === "") {
            displayErrorMessage('productName-error', 'Please enter a product name.');
            isValid = false;
        }

        if (description.trim() === "") {
            displayErrorMessage('description-error', 'Please enter a product description.');
            isValid = false;
        }

        if (parseInt(quantity) < 0) {
            displayErrorMessage('quantity-error', 'Please enter a valid non-negative quantity.');
            isValid = false;
        }

        if (!/^\d+(\.\d{1,2})?$/.test(price) || parseFloat(price) < 0) {
            displayErrorMessage('regularPrice-error', 'Please enter a valid non-negative price.');
            isValid = false;
        }

        if (!/^\d+(\.\d{1,2})?$/.test(saleprice) || parseFloat(saleprice) < 0) {
            displayErrorMessage('salePrice-error', 'Please enter a valid non-negative price.');
            isValid = false;
        }

        if (category.trim() === "") {
            displayErrorMessage('category-error', 'Please select a category.');
            isValid = false;
        }

      //   if (!images.files.length) {
      //       displayErrorMessage("images-error", 'Please select an image.');
      //       isValid = false;
      //   }

        return isValid;
    }

    function displayErrorMessage(elementId, message) {
        var errorElement = document.getElementById(elementId);
        errorElement.innerText = message;
        errorElement.style.display = "block";
    }

    function clearErrorMessages() {
        const errorElements = document.getElementsByClassName('error-message');
        Array.from(errorElements).forEach(element => {
            element.innerText = '';
            element.style.display = 'none';
        });
    }
</script>
